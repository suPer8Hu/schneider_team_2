<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}Freight Load Search{% endblock %}

{% block content %}
<div class="container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Header with Logo -->
    <div class="header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='schneider_logo.png') }}" alt="Schneider Logo" class="me-2" style="height: 50px;">
            <h1 class="text-orange mb-0">Freight Load Search</h1>
        </div>
        <nav>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-orange">Dashboard</a>
        </nav>
    </div>

    <div class="row mt-4">
        <!-- Left: Search Filters -->
        <div class="col-md-4">
            <div class="filter-panel">
                <h4 class="text-orange">Search Filters</h4>
                <form method="POST" id="search-form">
                    <!-- Capacity Type -->
                    <label for="type_truck">Capacity Type</label>
                    <select id="type_truck" name="type_truck" class="form-select mb-3" required>
                        <option value="Dry Van" {% if type_truck == 'Dry Van' %}selected{% endif %}>Dry Van</option>
                        <option value="Reefer" {% if type_truck == 'Reefer' %}selected{% endif %}>Reefer</option>
                        <option value="Flatbed" {% if type_truck == 'Flatbed' %}selected{% endif %}>Flatbed</option>
                        <option value="Power Only" {% if type_truck == 'Power Only' %}selected{% endif %}>Power Only</option>
                    </select>

                    <!-- Origin City -->
                    <label for="origin_city">Origin City</label>
                    <select id="origin_city" name="origin_city" class="form-select mb-3">
                        <option value="">All Origins</option>
                        {% for city in unique_origin_cities %}
                            <option value="{{ city }}" {% if origin_city == city %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>

                    <!-- Origin State -->
                    <label for="origin_state">Origin State</label>
                    <select id="origin_state" name="origin_state" class="form-select mb-3">
                        <!-- Options will be populated by JavaScript -->
                    </select>

                    <!-- Search Radius -->
                    <label for="radius">Search Radius (miles)</label>
                    <input type="range" class="form-range mb-3" id="radius" name="radius" min="25" max="400" step="25" value="{{ radius }}" oninput="document.getElementById('radiusValue').innerText = this.value + ' miles';">
                    <div id="radiusValue" class="text-center mb-3">{{ radius }} miles</div>

                    <!-- Destination City -->
                    <label for="dest_city">Destination City</label>
                    <select id="dest_city" name="dest_city" class="form-select mb-3">
                        <option value="">All Destinations</option>
                        {% for city in unique_dest_cities %}
                            <option value="{{ city }}" {% if dest_city == city %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>

                    <!-- Destination State -->
                    <label for="dest_state">Destination State</label>
                    <select id="dest_state" name="dest_state" class="form-select mb-3">
                        <!-- Options will be populated by JavaScript -->
                    </select>

                    <button type="submit" class="btn-search w-100 mt-3">Search</button>
                </form>
            </div> <!-- Close filter-panel -->
        </div> <!-- Close col-md-4 -->

        <!-- Right: Load Listings -->
        <div class="col-md-8">
            <div class="results-heading">Load Search Results</div>

            {% if results %}
                <!-- Loop over results -->
                {% for result in results %}
                <div class="load-entry mt-3">
                    <div class="d-flex justify-content-between">
                        <div>
                            <p><strong>Origin:</strong> {{ result['Pickup_City'] }}, {{ result['Pickup_State'] }}</p>
                            <p><strong>Destination:</strong> {{ result['Destination_City'] }}, {{ result['Destination_State'] }}</p>
                            <p><strong>Weight:</strong> {{ result['TOTAL_WEIGHT'] }}</p>
                            <p><strong>Transport Mode:</strong> {{ result['TRANSPORT_MODE'] }}</p>
                        </div>
                        <div>
                            <button class="btn-watch" onclick="getMap({{ result['LOAD_ID'] }})">Watch</button>
                            <button class="btn-book">Contact to Book</button>
                        </div>
                    </div>

                    <!-- Route Map Section -->
                    <div class="map-container mt-4 text-center" id="route-map-{{ result['LOAD_ID'] }}" style="display:none;">
                        <h5 class="text-center">Route Map</h5>
                        <img id="map-image-{{ result['LOAD_ID'] }}" class="img-fluid rounded" alt="Route Map">
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>No loads available. Please refine your search.</p>
            {% endif %}
        </div> <!-- Close col-md-8 -->
    </div> <!-- Close row -->
</div> <!-- Close container -->

<!-- Scripts -->
<script>
    // Origin City Change Event
    document.getElementById('origin_city').addEventListener('change', function() {
        const selectedCity = this.value;

        fetch(`/get_states_for_city?city=${encodeURIComponent(selectedCity)}&type=origin`)
            .then(response => response.json())
            .then(data => {
                const originStateDropdown = document.getElementById('origin_state');
                originStateDropdown.innerHTML = ''; // Clear current states

                if (data.states.length === 1) {
                    // Only one state, automatically select it
                    const option = document.createElement('option');
                    option.value = data.states[0];
                    option.textContent = data.states[0];
                    originStateDropdown.appendChild(option);
                } else {
                    // Multiple states, let user select
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Origin State';
                    originStateDropdown.appendChild(defaultOption);

                    data.states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = state;
                        originStateDropdown.appendChild(option);
                    });
                }
            });
    });

    // Destination City Change Event
    document.getElementById('dest_city').addEventListener('change', function() {
        const selectedCity = this.value;

        fetch(`/get_states_for_city?city=${encodeURIComponent(selectedCity)}&type=dest`)
            .then(response => response.json())
            .then(data => {
                const destStateDropdown = document.getElementById('dest_state');
                destStateDropdown.innerHTML = ''; // Clear current states

                if (data.states.length === 1) {
                    // Only one state, automatically select it
                    const option = document.createElement('option');
                    option.value = data.states[0];
                    option.textContent = data.states[0];
                    destStateDropdown.appendChild(option);
                } else {
                    // Multiple states, let user select
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Destination State';
                    destStateDropdown.appendChild(defaultOption);

                    data.states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = state;
                        destStateDropdown.appendChild(option);
                    });
                }
            });
    });

    // Function to Fetch and Display the Map
    function getMap(loadId) {
        fetch(`/get_map?load_id=${loadId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const img = document.getElementById(`map-image-${loadId}`);
                img.src = URL.createObjectURL(blob);
                document.getElementById(`route-map-${loadId}`).style.display = 'block';
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                alert('Failed to load the map. Please try again later.');
            });
    }
</script>
{% endblock %}